<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§Æ‡§ø‡§∂‡§® 5 CR - ‡§≤‡§æ‡§à‡§µ‡•ç‡§π ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</title>
    
    <!-- Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js library for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        /* CSS code is embedded here */
        :root {
            --bg-color: #0f172a; /* Dark blue background */
            --card-color: #1e293b; /* Slightly lighter card background */
            --border-color: #334155;
            --text-primary: #e2e8f0; /* Light text */
            --text-secondary: #94a3b8; /* Dimmer text */
            --accent-primary: #38bdf8; /* Bright blue for highlights */
            --accent-secondary: #4ade80; /* Green for growth */
            --accent-danger: #f43f5e; /* Red for negative values */
            --font-family: 'Poppins', sans-serif;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 24px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .dashboard-container {
            max-width: 1600px;
            margin: auto;
            display: grid;
            gap: 24px;
        }

        /* --- Header --- */
        .dashboard-header {
            background: linear-gradient(90deg, #1e293b, #0f172a);
            border: 1px solid var(--border-color);
            padding: 24px;
            border-radius: 16px;
            text-align: center;
        }
        .dashboard-header h1 {
            margin: 0;
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-primary), #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-info {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 32px;
            margin-top: 16px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* --- KPI Cards --- */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
        }
        .kpi-card {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 24px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .kpi-title {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 400;
        }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1.1;
            color: var(--text-primary);
        }
        .kpi-subtitle {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        #totalGrowth.positive { color: var(--accent-secondary); }
        #totalGrowth.negative { color: var(--accent-danger); }
        #targetAmount { color: var(--accent-primary); }

        /* --- Progress Card --- */
        .progress-card {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 24px;
            border-radius: 16px;
        }
        .progress-card h3 { margin: 0 0 16px 0; color: var(--text-primary); font-weight: 600; }
        .progress-bar-container {
            background-color: var(--bg-color);
            border-radius: 10px;
            overflow: hidden;
            height: 30px;
        }
        .progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), #818cf8);
            transition: width 1.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .progress-label {
            text-align: right;
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 8px;
            color: var(--accent-primary);
        }

        /* --- Charts and Tables --- */
        .grid-layout {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 24px;
        }
        .chart-container, .table-container {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 24px;
            border-radius: 16px;
        }
        .chart-container {
            grid-column: span 12;
            height: 450px;
        }
        .table-container { grid-column: span 12; }
        @media (min-width: 1024px) {
            .chart-container:nth-child(1) { grid-column: span 5; }
            .chart-container:nth-child(2) { grid-column: span 7; }
        }
        .table-container h3, .chart-container h3 { margin: 0 0 16px 0; color: var(--text-primary); font-weight: 600; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { color: var(--text-secondary); font-weight: 600; font-size: 0.9rem; }
        tbody tr { transition: background-color 0.2s; }
        tbody tr:hover { background-color: #2b3a50; }
        td:nth-child(2), td:nth-child(3), td:nth-child(4) { text-align: right; }
        .positive { color: var(--accent-secondary) !important; font-weight: 600; }
        .negative { color: var(--accent-danger) !important; font-weight: 600; }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <h1>‡§Æ‡§ø‡§∂‡§® ‡•´ ‡§ï‡•ã‡§ü‡•Ä - ‡§≤‡§æ‡§à‡§µ‡•ç‡§π ‡§™‡•ç‡§∞‡§ó‡§§‡•Ä ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h1>
            <div class="header-info">
                <span>üìÖ ‡§∏‡•Å‡§∞‡•Å‡§µ‡§æ‡§§: <b id="startDate">...</b></span>
                <span>üèÅ ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§§‡§æ‡§∞‡•Ä‡§ñ: <b id="endDate">...</b></span>
                <span>‚è≥ ‡§¶‡§ø‡§µ‡§∏ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï: <b id="daysLeft">...</b></span>
            </div>
        </header>

        <!-- KPI Grid -->
        <div class="kpi-grid">
            <div class="kpi-card"><div class="kpi-title">‡§∏‡•Å‡§∞‡•Å‡§µ‡§æ‡§§‡•Ä‡§ö‡•á ‡§Ü‡§â‡§ü‡§∏‡•ç‡§ü‡§Å‡§°‡§ø‡§Ç‡§ó</div><div class="kpi-value" id="initialOutstanding">‚Çπ 0</div></div>
            <div class="kpi-card"><div class="kpi-title">‡§è‡§ï‡•Ç‡§£ ‡§µ‡§æ‡§¢ (Growth)</div><div class="kpi-value" id="totalGrowth">‚Çπ 0</div><div class="kpi-subtitle">‡§®‡•á‡§ü (‡§µ‡§æ‡§ü‡§™ - ‡§µ‡§∏‡•Å‡§≤‡•Ä)</div></div>
            <div class="kpi-card"><div class="kpi-title">‡§∏‡§ß‡•ç‡§Ø‡§æ‡§ö‡•á ‡§Ü‡§â‡§ü‡§∏‡•ç‡§ü‡§Å‡§°‡§ø‡§Ç‡§ó</div><div class="kpi-value" id="currentOutstanding">‚Çπ 0</div></div>
            <div class="kpi-card"><div class="kpi-title">üéØ ‡§ß‡•ç‡§Ø‡•á‡§Ø (Target)</div><div class="kpi-value" id="targetAmount">‚Çπ 0</div></div>
        </div>

        <!-- Progress Card -->
        <div class="progress-card">
            <h3>‡§ß‡•ç‡§Ø‡•á‡§Ø‡§™‡•Ç‡§∞‡•ç‡§§‡•Ä (%)</h3>
            <div class="progress-bar-container"><div class="progress-bar" id="goalProgressBar"></div></div>
            <div class="progress-label" id="goalProgressLabel">0%</div>
        </div>
        
        <!-- Charts and Table Layout -->
        <div class="grid-layout">
            <div class="chart-container"><h3>üèÜ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ï‡§æ‡§Æ‡§ó‡§ø‡§∞‡•Ä (‡§è‡§ï‡•Ç‡§£ ‡§µ‡§æ‡§¢)</h3><canvas id="staffPerformanceChart"></canvas></div>
            <div class="chart-container"><h3>üìà ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§ü‡•ç‡§∞‡•á‡§Ç‡§° (‡§µ‡§æ‡§ü‡§™ vs ‡§µ‡§∏‡•Å‡§≤‡•Ä)</h3><canvas id="monthlyTrendChart"></canvas></div>
            <div class="table-container"><h3>üìä ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä-‡§®‡§ø‡§π‡§æ‡§Ø ‡§∏‡§µ‡§ø‡§∏‡•ç‡§§‡§∞ ‡§Ö‡§π‡§µ‡§æ‡§≤</h3>
                <table id="staffTable">
                    <thead><tr><th>‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§±‡•ç‡§Ø‡§æ‡§ö‡•á ‡§®‡§æ‡§µ</th><th style="text-align: right;">‡§è‡§ï‡•Ç‡§£ ‡§µ‡§æ‡§ü‡§™</th><th style="text-align: right;">‡§è‡§ï‡•Ç‡§£ ‡§µ‡§∏‡•Å‡§≤‡•Ä</th><th style="text-align: right;">‡§è‡§ï‡•Ç‡§£ ‡§µ‡§æ‡§¢ (Growth)</th></tr></thead>
                    <tbody id="staffTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ‚ñº‚ñº‚ñº‚ñº‚ñº ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§á‡§•‡•á ‡§≠‡§∞‡§æ ‚ñº‚ñº‚ñº‚ñº‚ñº
 const API_KEY = 'AIzaSyADpmUttHbznSowws1nk19BmJ7TjktsApU';
        const SHEET_ID = 'https://docs.google.com/spreadsheets/d/1Mx7s64XhfbzwRNmUJ97Y9pep58UZ5L-yzENA34R23x8/edit?usp=sharing'; // ‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§∂‡•Ä‡§ü‡§ö‡§æ ‡§Ü‡§Ø‡§°‡•Ä

        const SETTINGS_SHEET = 'Settings';
        const DAILY_DATA_SHEET = 'DailyData';
        // ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤

        // Function to fetch data from Google Sheets API
        async function fetchSheetData(sheetName) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${sheetName}?key=${API_KEY}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Network error for ${sheetName}`);
                const data = await response.json();
                if (!data.values || data.values.length < 2) return [];
                const headers = data.values[0];
                const rows = data.values.slice(1);
                return rows.map(row => {
                    let obj = {};
                    headers.forEach((header, index) => { obj[header] = row[index] || '0'; });
                    return obj;
                });
            } catch (error) {
                console.error(`Error fetching ${sheetName}:`, error);
                document.body.innerHTML = `<h2 style="color:red; text-align:center;">'${sheetName}' ‡§∂‡•Ä‡§ü‡§Æ‡§ß‡•Ç‡§® ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡•Å‡§Æ‡§ö‡•Ä API Key ‡§Ü‡§£‡§ø Sheet Sharing ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§ú ‡§§‡§™‡§æ‡§∏‡§æ.</h2>`;
                return null;
            }
        }

        // Function to format numbers as Indian Rupees currency
        function formatCurrency(num, compact = false) {
            const value = parseFloat(String(num).replace(/,/g, '')) || 0;
            const options = { style: 'currency', currency: 'INR', minimumFractionDigits: 0, maximumFractionDigits: 0 };
            if (compact) {
                options.notation = 'compact';
                options.compactDisplay = 'short';
            }
            return new Intl.NumberFormat('en-IN', options).format(value);
        }

        // Main function to load and render the dashboard
        async function loadDashboard() {
            const [settingsData, dailyData] = await Promise.all([
                fetchSheetData(SETTINGS_SHEET),
                fetchSheetData(DAILY_DATA_SHEET)
            ]);
            
            if (!settingsData || !dailyData) return; // Stop if data loading failed

            // 1. Process Settings
            const settings = {};
            settingsData.forEach(item => { settings[item['Setting Name']] = item['Value']; });
            const targetGrowth = parseFloat(settings['Target']);
            const initialOutstanding = parseFloat(settings['Initial Outstanding']);
            const startDateStr = settings['Start Date'];
            const endDateStr = settings['End Date'];

            // 2. Process Daily Data
            const staffPerformance = {};
            const monthlyData = {};

            dailyData.forEach(row => {
                const staffName = row['Staff Name'];
                if (!staffName || staffName.trim() === '') return;
                const disbursement = parseFloat(row['New Accounts Disbursement']) || 0;
                const recovery = parseFloat(row['Recovery']) || 0;
                staffPerformance[staffName] = staffPerformance[staffName] || { disbursement: 0, recovery: 0, growth: 0 };
                staffPerformance[staffName].disbursement += disbursement;
                staffPerformance[staffName].recovery += recovery;
                staffPerformance[staffName].growth += (disbursement - recovery);
                
                const dateParts = row['Date'].split('-');
                if (dateParts.length === 3) {
                    const monthYear = `01-${dateParts[1]}-${dateParts[2]}`;
                    monthlyData[monthYear] = monthlyData[monthYear] || { disbursement: 0, recovery: 0 };
                    monthlyData[monthYear].disbursement += disbursement;
                    monthlyData[monthYear].recovery += recovery;
                }
            });

            const totalDisbursement = Object.values(staffPerformance).reduce((sum, s) => sum + s.disbursement, 0);
            const totalRecovery = Object.values(staffPerformance).reduce((sum, s) => sum + s.recovery, 0);

            // 3. Calculate Key Metrics
            const netGrowth = totalDisbursement - totalRecovery;
            const currentOutstanding = initialOutstanding + netGrowth;
            const goalAchievedPercentage = targetGrowth > 0 ? (netGrowth / targetGrowth) * 100 : 0;
            const [day, month, year] = endDateStr.split('-');
            const endDate = new Date(`${year}-${month}-${day}`);
            const daysLeft = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));

            // 4. Update UI Elements
            document.getElementById('startDate').textContent = startDateStr;
            document.getElementById('endDate').textContent = endDateStr;
            document.getElementById('daysLeft').textContent = daysLeft > 0 ? daysLeft : 0;
            document.getElementById('initialOutstanding').textContent = formatCurrency(initialOutstanding, true);
            document.getElementById('targetAmount').textContent = formatCurrency(targetGrowth, true);
            document.getElementById('totalGrowth').textContent = formatCurrency(netGrowth, true);
            document.getElementById('totalGrowth').className = `kpi-value ${netGrowth >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('currentOutstanding').textContent = formatCurrency(currentOutstanding, true);
            
            const progressBar = document.getElementById('goalProgressBar');
            setTimeout(() => { progressBar.style.width = `${Math.min(goalAchievedPercentage, 100)}%`; }, 100);
            document.getElementById('goalProgressLabel').textContent = `${goalAchievedPercentage.toFixed(2)}%`;

            // 5. Render Charts and Table
            renderStaffPerformanceChart(staffPerformance);
            renderMonthlyTrendChart(monthlyData);
            renderStaffTable(staffPerformance);
        }

        // Chart and table rendering functions
        let staffChartInstance, monthlyChartInstance;
        const chartOptions = {
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { color: 'var(--text-secondary)' }, grid: { color: 'var(--border-color)' } }, x: { ticks: { color: 'var(--text-secondary)' }, grid: { color: 'var(--border-color)' } } },
            plugins: { legend: { labels: { color: 'var(--text-primary)' } } }
        };

        function renderStaffPerformanceChart(staffData) {
            const ctx = document.getElementById('staffPerformanceChart').getContext('2d');
            if (staffChartInstance) staffChartInstance.destroy();
            
            const sortedStaff = Object.entries(staffData).sort(([,a],[,b]) => b.growth - a.growth).slice(0, 10); // Top 10
            const labels = sortedStaff.map(s => s[0]);
            const growthData = sortedStaff.map(s => s[1].growth);

            staffChartInstance = new Chart(ctx, { 
                type: 'bar', 
                data: { labels, datasets: [{ label: '‡§è‡§ï‡•Ç‡§£ ‡§µ‡§æ‡§¢ (Growth)', data: growthData, backgroundColor: 'rgba(56, 189, 248, 0.6)', borderColor: 'rgba(56, 189, 248, 1)', borderWidth: 1 }] }, 
                options: chartOptions 
            });
        }
        function renderMonthlyTrendChart(monthlyData) {
            const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
            if (monthlyChartInstance) monthlyChartInstance.destroy();
            
            const sortedMonths = Object.keys(monthlyData).sort((a,b) => new Date(a) - new Date(b));
            
            monthlyChartInstance = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: sortedMonths,
                    datasets: [
                        { label: '‡§è‡§ï‡•Ç‡§£ ‡§µ‡§æ‡§ü‡§™', data: sortedMonths.map(m => monthlyData[m].disbursement), borderColor: 'var(--accent-primary)', backgroundColor: 'rgba(56, 189, 248, 0.2)', fill: true, tension: 0.3 }, 
                        { label: '‡§è‡§ï‡•Ç‡§£ ‡§µ‡§∏‡•Å‡§≤‡•Ä', data: sortedMonths.map(m => monthlyData[m].recovery), borderColor: 'var(--accent-danger)', backgroundColor: 'rgba(244, 63, 94, 0.2)', fill: true, tension: 0.3 }
                    ] 
                }, 
                options: { ...chartOptions, scales: { ...chartOptions.scales, x: { type: 'time', time: { unit: 'month' }, ticks: { color: 'var(--text-secondary)' } } } }
            });
        }
        function renderStaffTable(staffData) {
            const tableBody = document.getElementById('staffTableBody');
            tableBody.innerHTML = '';
            const sortedStaff = Object.entries(staffData).sort(([,a],[,b]) => b.growth - a.growth);
            for (const [name, data] of sortedStaff) {
                const growthClass = data.growth > 0 ? 'positive' : (data.growth < 0 ? 'negative' : '');
                tableBody.innerHTML += `
                    <tr>
                        <td>${name}</td>
                        <td>${formatCurrency(data.disbursement)}</td>
                        <td>${formatCurrency(data.recovery)}</td>
                        <td class="${growthClass}">${formatCurrency(data.growth)}</td>
                    </tr>`;
            }
        }

        // Load the dashboard when the page is ready
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§Æ‡§ø‡§∂‡§® 5 CR - ‡§≤‡§æ‡§à‡§µ‡•ç‡§π ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        :root {
            --bg-color: #f1f5f9;
            --card-color: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-primary: #0ea5e9;
            --accent-secondary: #22c55e;
            --accent-danger: #ef4444;
            --font-family: 'Poppins', sans-serif;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 16px; /* Reduced padding for mobile */
        }
        @media (min-width: 768px) {
            body { padding: 24px; }
        }
        body.modal-open { overflow: hidden; }

        .dashboard-container { max-width: 1600px; margin: auto; display: grid; gap: 24px; }

        .dashboard-header {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 24px;
            border-radius: 16px;
            text-align: center;
        }
        .dashboard-header h1 {
            margin: 0;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-primary), #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-info {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 16px 32px;
            margin-top: 16px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .date-filter-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .date-filter-container input[type="date"], .date-filter-container button {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: #f8fafc;
        }
        .date-filter-container button {
            background-color: var(--accent-primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .kpi-grid, .performer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
        }
        .kpi-card {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            padding: 24px;
            border-radius: 16px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 24px rgba(149, 157, 165, 0.2);
        }
        .clickable { cursor: pointer; }
        .kpi-title { font-size: 1rem; color: var(--text-secondary); }
        .kpi-value { font-size: clamp(1.8rem, 5vw, 2.5rem); font-weight: 700; }
        .kpi-subtitle { font-size: 0.8rem; color: var(--text-secondary); }
        .positive { color: var(--accent-secondary) !important; font-weight: 600; }
        .negative { color: var(--accent-danger) !important; font-weight: 600; }
        #targetAmount { color: var(--accent-primary); }

        .performer-card h3 { font-size: 1rem; color: var(--text-secondary); margin: 0 0 8px 0; }
        .performer-card ol { list-style: none; padding: 0; margin: 0; }
        .performer-card li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 0.95rem; }
        .performer-card li:last-child { border-bottom: none; }
        .performer-card span:last-child { font-weight: 700; }
        .performer-card a { display: block; margin-top: 16px; text-align: right; color: var(--accent-primary); text-decoration: none; font-weight: 600; }

        .progress-card { background-color: var(--card-color); border: 1px solid var(--border-color); padding: 24px; border-radius: 16px; }
        .progress-bar-container { background-color: var(--border-color); border-radius: 10px; overflow: hidden; height: 30px; }
        .progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent-primary), #818cf8); transition: width 1.5s cubic-bezier(0.25, 1, 0.5, 1); }
        .progress-label { text-align: right; font-size: 1.2rem; font-weight: bold; margin-top: 8px; color: var(--accent-primary); }
        
        .grid-layout { display: grid; grid-template-columns: repeat(12, 1fr); gap: 24px; }
        .chart-container, .table-container { background-color: var(--card-color); border: 1px solid var(--border-color); padding: 24px; border-radius: 16px; }
        .chart-container { grid-column: span 12; height: 450px; }
        .table-container { grid-column: span 12; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        @media (min-width: 1024px) {
            .chart-container:nth-child(1) { grid-column: span 5; }
            .chart-container:nth-child(2) { grid-column: span 7; }
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        tbody tr:hover { background-color: #f8fafc; }
        td:nth-child(2), td:nth-child(3), td:nth-child(4) { text-align: right; }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(15, 23, 42, 0.7); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--card-color); padding: 24px; border-radius: 16px; width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-header h2 { margin: 0; font-size: 1.25rem; }
        .modal-close-btn { font-size: 2rem; color: var(--text-secondary); cursor: pointer; border: none; background: none; }
        .modal-body { overflow-y: auto; }

        .chart-details {
            display: flex;
            justify-content: space-around;
            margin-top: 24px;
            font-size: 1.1rem;
            color: var(--text-secondary);
        }
        .chart-details span b {
            font-weight: 700;
            color: var(--text-primary);
        }
        .chart-details span b.positive {
            color: var(--accent-secondary);
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <h1>‡§Æ‡§ø‡§∂‡§® ‡•´ ‡§ï‡•ã‡§ü‡•Ä - ‡§≤‡§æ‡§à‡§µ‡•ç‡§π ‡§™‡•ç‡§∞‡§ó‡§§‡•Ä ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h1>
            <div class="header-info">
                <span>üìÖ ‡§Æ‡•Ç‡§≥ ‡§∏‡•Å‡§∞‡•Å‡§µ‡§æ‡§§: <b id="startDate">...</b></span>
                <span>üèÅ ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§§‡§æ‡§∞‡•Ä‡§ñ: <b id="endDate">...</b></span>
                <span>‚è≥ ‡§¶‡§ø‡§µ‡§∏ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï: <b id="daysLeft">...</b></span>
            </div>
            <div class="date-filter-container">
                <label for="startDateFilter">‡§™‡§æ‡§∏‡•Ç‡§®:</label>
                <input type="date" id="startDateFilter">
                <label for="endDateFilter">‡§™‡§∞‡•ç‡§Ø‡§Ç‡§§:</label>
                <input type="date" id="endDateFilter">
                <button id="filterBtn">‡§´‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§ï‡§∞‡§æ</button>
            </div>
        </header>

        <!-- KPI Grid -->
        <div class="kpi-grid">
            <div class="kpi-card clickable" id="kpiInitialCard"><div class="kpi-title">‡§∏‡•Å‡§∞‡•Å‡§µ‡§æ‡§§‡•Ä‡§ö‡•á ‡§Ü‡§â‡§ü‡§∏‡•ç‡§ü‡§Å‡§°‡§ø‡§Ç‡§ó ‚ñæ</div><div class="kpi-value" id="initialOutstanding">‚Çπ 0</div></div>
            <div class="kpi-card clickable" id="kpiGrowthCard"><div class="kpi-title">‡§®‡§ø‡§µ‡•ç‡§µ‡§≥ ‡§µ‡§æ‡§¢ (Growth) ‚ñæ</div><div class="kpi-value" id="totalGrowth">‚Çπ 0</div><div class="kpi-subtitle">‡§®‡§ø‡§µ‡•ç‡§µ‡§≥ (‡§µ‡§æ‡§ü‡§™ - ‡§µ‡§∏‡•Å‡§≤‡•Ä)</div></div>
            <div class="kpi-card clickable" id="kpiCurrentCard"><div class="kpi-title">‡§∏‡§ß‡•ç‡§Ø‡§æ‡§ö‡•á ‡§Ü‡§â‡§ü‡§∏‡•ç‡§ü‡§Å‡§°‡§ø‡§Ç‡§ó ‚ñæ</div><div class="kpi-value" id="currentOutstanding">‚Çπ 0</div></div>
            <div class="kpi-card"><div class="kpi-title">üéØ ‡§ß‡•ç‡§Ø‡•á‡§Ø (Target)</div><div class="kpi-value" id="targetAmount">‚Çπ 0</div></div>
        </div>
        
        <!-- Performer Grid -->
        <div class="performer-grid">
            <div class="kpi-card performer-card">
                <h3>üèÜ ‡§ü‡•â‡§™ ‡•© ‡§™‡§∞‡§´‡•â‡§∞‡•ç‡§Æ‡§∞‡•ç‡§∏ (‡§µ‡§æ‡§¢)</h3>
                <ol id="topPerformersList"></ol>
                <a href="#staffTable">‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§Ø‡§æ‡§¶‡•Ä ‡§™‡§π‡§æ &rarr;</a>
            </div>
            <div class="kpi-card performer-card">
                <h3>üîª ‡§∏‡§∞‡•ç‡§µ‡§æ‡§§ ‡§ï‡§Æ‡•Ä ‡§ï‡§æ‡§Æ‡§ó‡§ø‡§∞‡•Ä (‡§µ‡§æ‡§¢)</h3>
                <ol id="lowPerformersList"></ol>
                 <a href="#staffTable">‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§Ø‡§æ‡§¶‡•Ä ‡§™‡§π‡§æ &rarr;</a>
            </div>
        </div>

        <div class="progress-card">
            <h3>‡§è‡§ï‡•Ç‡§£ ‡§ß‡•ç‡§Ø‡•á‡§Ø‡§™‡•Ç‡§∞‡•ç‡§§‡•Ä (%)</h3>
            <div class="progress-bar-container"><div class="progress-bar" id="goalProgressBar"></div></div>
            <div class="progress-label" id="goalProgressLabel">0%</div>
        </div>
        
        <div class="grid-layout">
            <div class="chart-container"><h3>üèÜ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ï‡§æ‡§Æ‡§ó‡§ø‡§∞‡•Ä (‡§è‡§ï‡•Ç‡§£ ‡§µ‡§æ‡§¢)</h3><canvas id="staffPerformanceChart"></canvas></div>
            <div class="chart-container"><h3>üìà ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§ü‡•ç‡§∞‡•á‡§Ç‡§° (‡§µ‡§æ‡§ü‡§™ vs ‡§µ‡§∏‡•Å‡§≤‡•Ä)</h3><canvas id="monthlyTrendChart"></canvas></div>
            
            <div class="chart-container" style="grid-column: span 12; text-align: center;">
                <h3>üéØ ‡§ö‡§æ‡§≤‡•Ç ‡§Æ‡§π‡§ø‡§®‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§™‡•ç‡§∞‡§ó‡§§‡•Ä</h3>
                <div style="position: relative; width: 80%; max-width: 280px; margin: auto; height: 280px;">
                    <canvas id="currentMonthGoalChart"></canvas>
                    <div id="currentMonthProgressText" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: clamp(1.8rem, 5vw, 2.5rem); font-weight: 700; color: var(--text-primary);"></div>
                </div>
                <div class="chart-details">
                    <span>‡§™‡•Ç‡§∞‡•ç‡§£: <b id="currentMonthAchieved" class="positive">‚Çπ 0</b></span>
                    <span>‡§ß‡•ç‡§Ø‡•á‡§Ø: <b id="currentMonthTarget">‚Çπ 0</b></span>
                </div>
            </div>

            <div class="table-container" id="staffTable"><h3>üìä ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä-‡§®‡§ø‡§π‡§æ‡§Ø ‡§∏‡§µ‡§ø‡§∏‡•ç‡§§‡§∞ ‡§Ö‡§π‡§µ‡§æ‡§≤</h3>
                <table>
                    <thead><tr><th>‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§±‡•ç‡§Ø‡§æ‡§ö‡•á ‡§®‡§æ‡§µ</th><th>‡§è‡§ï‡•Ç‡§£ ‡§µ‡§æ‡§ü‡§™</th><th>‡§è‡§ï‡•Ç‡§£ ‡§µ‡§∏‡•Å‡§≤‡•Ä</th><th>‡§è‡§ï‡•Ç‡§£ ‡§µ‡§æ‡§¢ (Growth)</th></tr></thead>
                    <tbody id="staffTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Details Modal -->
    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">‡§§‡§™‡§∂‡•Ä‡§≤</h2>
                <button id="closeModalBtn" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        // ‚ñº‚ñº‚ñº‚ñº‚ñº ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§á‡§•‡•á ‡§≠‡§∞‡§æ ‚ñº‚ñº‚ñº‚ñº‚ñº
        const API_KEY = 'AIzaSyADpmUttHbznSowws1nk19BmJ7TjktsApU';
        const SHEET_ID = '1Mx7s64XhfbzwRNmUJ97Y9pep58UZ5L-yzENA34R23x8'; // ‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§∂‡•Ä‡§ü‡§ö‡§æ ‡§Ü‡§Ø‡§°‡•Ä

        const SETTINGS_SHEET = 'Settings';
        const DAILY_DATA_SHEET = 'DailyData';
        const INITIAL_OUTSTANDING_SHEET = 'InitialOutstanding';
        // ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤

        let _allDailyData = [];
        let _initialStaffData = {};
        let _settings = {};
        let _currentStaffPerformance = {};
        let _currentStaffOutstanding = {};
        
        async function fetchSheetData(sheetName) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${sheetName}?key=${API_KEY}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Network error for '${sheetName}'`);
                const data = await response.json();
                if (!data.values || data.values.length < 2) {
                    console.warn(`Sheet '${sheetName}' is empty or has no data.`);
                    return [];
                }
                const headers = data.values[0].map(h => h.trim());
                const rows = data.values.slice(1);
                return rows.map(row => {
                    let obj = {};
                    headers.forEach((header, index) => { obj[header] = row[index] || '0'; });
                    if(obj['Date']) {
                        const dateParts = obj['Date'].split('-');
                        if (dateParts.length === 3) obj.dateObj = new Date(`${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`);
                    }
                    return obj;
                });
            } catch (error) {
                console.error(`Error fetching ${sheetName}:`, error);
                document.body.innerHTML = `<h2 style="color:red; text-align:center;">'${sheetName}' ‡§∂‡•Ä‡§ü‡§Æ‡§ß‡•Ç‡§® ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡•Å‡§Æ‡§ö‡•Ä API Key, Sheet ID ‡§Ü‡§£‡§ø Sheet Sharing ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§ú ‡§§‡§™‡§æ‡§∏‡§æ.</h2>`;
                return null;
            }
        }

        function formatCurrency(num) {
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(parseFloat(num) || 0);
        }
        
        function formatCurrencyPrecise(num) {
            const value = parseFloat(num) || 0;
            if (Math.abs(value) >= 10000000) {
                return `‚Çπ ${(value / 10000000).toFixed(2)} Cr`;
            }
            if (Math.abs(value) >= 100000) {
                return `‚Çπ ${(value / 100000).toFixed(2)} L`;
            }
            return formatCurrency(value);
        }

        function filterAndRenderDashboard(startDate, endDate) {
            const filteredData = _allDailyData.filter(row => {
                if (!row.dateObj) return false;
                return (!startDate || row.dateObj >= startDate) && (!endDate || row.dateObj <= endDate);
            });

            const staffPerformance = {};
            const monthlyData = {};

            filteredData.forEach(row => {
                const staffName = row['Staff Name'];
                if (!staffName || staffName.trim() === '') return;
                const disbursement = parseFloat(row['New Accounts Disbursement']) || 0;
                const recovery = parseFloat(row['Recovery']) || 0;
                
                staffPerformance[staffName] = staffPerformance[staffName] || { name: staffName, disbursement: 0, recovery: 0, growth: 0 };
                staffPerformance[staffName].disbursement += disbursement;
                staffPerformance[staffName].recovery += recovery;
                staffPerformance[staffName].growth += (disbursement - recovery);
                
                const monthYear = row.dateObj.toISOString().slice(0, 7);
                monthlyData[monthYear] = monthlyData[monthYear] || { disbursement: 0, recovery: 0, growth: 0 };
                monthlyData[monthYear].disbursement += disbursement;
                monthlyData[monthYear].recovery += recovery;
                monthlyData[monthYear].growth += (disbursement - recovery);
            });

            const allStaffNames = new Set([...Object.keys(_initialStaffData), ...Object.keys(staffPerformance)]);
            _currentStaffOutstanding = {};
            allStaffNames.forEach(name => {
                const initial = _initialStaffData[name] || 0;
                const growth = (staffPerformance[name] || { growth: 0 }).growth;
                _currentStaffOutstanding[name] = initial + growth;
            });
            _currentStaffPerformance = staffPerformance;
            
            const totalDisbursement = Object.values(staffPerformance).reduce((sum, s) => sum + s.disbursement, 0);
            const totalRecovery = Object.values(staffPerformance).reduce((sum, s) => sum + s.recovery, 0);
            const netGrowth = totalDisbursement - totalRecovery;
            const totalInitialOutstanding = parseFloat(_settings['Initial Outstanding']);
            const currentOutstanding = totalInitialOutstanding + netGrowth;
            const targetGrowth = parseFloat(_settings['Target']);
            const goalAchievedPercentage = targetGrowth > 0 ? (netGrowth / targetGrowth) * 100 : 0;

            document.getElementById('totalGrowth').textContent = formatCurrencyPrecise(netGrowth);
            document.getElementById('totalGrowth').className = `kpi-value ${netGrowth >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('currentOutstanding').textContent = formatCurrencyPrecise(currentOutstanding);
            
            document.getElementById('goalProgressBar').style.width = `${Math.min(goalAchievedPercentage, 100)}%`;
            document.getElementById('goalProgressLabel').textContent = `${goalAchievedPercentage.toFixed(2)}%`;

            renderStaffPerformanceChart(staffPerformance);
            renderMonthlyTrendChart(monthlyData);
            renderStaffTable(staffPerformance);
            renderPerformerCards(staffPerformance);
            renderCurrentMonthPieChart(monthlyData);
        }
        
        let staffChartInstance, monthlyChartInstance, currentMonthPieChartInstance;
        const chartOptions = {
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { color: 'var(--text-secondary)' }, grid: { color: 'var(--border-color)' } }, x: { ticks: { color: 'var(--text-secondary)' }, grid: { color: 'var(--border-color)' } } },
            plugins: { legend: { labels: { color: 'var(--text-primary)' } } }
        };

        // ‚ñº‚ñº‚ñº ‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§Æ‡§æ‡§ó‡§£‡•Ä‡§®‡•Å‡§∏‡§æ‡§∞ ‡§™‡§æ‡§Ø ‡§ö‡§æ‡§∞‡•ç‡§ü‡§ö‡•ç‡§Ø‡§æ ‡§≤‡•â‡§ú‡§ø‡§ï‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§Ö‡§ö‡•Ç‡§ï ‡§¨‡§¶‡§≤ ‡§ï‡•á‡§≤‡§æ ‡§Ü‡§π‡•á ‚ñº‚ñº‚ñº
        function renderCurrentMonthPieChart(monthlyData) {
            // --- ‡§®‡§µ‡•Ä‡§® ‡§≤‡•â‡§ú‡§ø‡§ï: ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§æ‡§≤‡§æ‡§µ‡§ß‡•Ä ‡§Ü‡§£‡§ø ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü‡§®‡•Å‡§∏‡§æ‡§∞ ‡§Æ‡§π‡§ø‡§®‡•ç‡§Ø‡§æ‡§ö‡•á ‡§ß‡•ç‡§Ø‡•á‡§Ø ‡§ï‡§æ‡§¢‡§æ ---
            const totalTarget = parseFloat(_settings['Target']) || 50000000; // Settings ‡§Æ‡§ß‡•Ç‡§® ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü ‡§ò‡•ç‡§Ø‡§æ ‡§ï‡§ø‡§Ç‡§µ‡§æ 5 ‡§ï‡•ã‡§ü‡•Ä ‡§°‡•Ä‡§´‡•â‡§≤‡•ç‡§ü ‡§†‡•á‡§µ‡§æ

            const fixedStartDate = new Date('2024-10-01T00:00:00');
            const fixedEndDate = new Date('2025-02-12T23:59:59');

            // ‡§ï‡§æ‡§≤‡§æ‡§µ‡§ß‡•Ä‡§§‡•Ä‡§≤ ‡§è‡§ï‡•Ç‡§£ ‡§¶‡§ø‡§µ‡§∏ ‡§Æ‡•ã‡§ú‡§æ
            const timeDiff = fixedEndDate.getTime() - fixedStartDate.getTime();
            const totalDaysInPeriod = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            // ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§¶‡§ø‡§µ‡§∏‡§æ‡§ö‡•á ‡§ß‡•ç‡§Ø‡•á‡§Ø (Daily Target) ‡§ï‡§æ‡§¢‡§æ
            const dailyTarget = totalDaysInPeriod > 0 ? totalTarget / totalDaysInPeriod : 0;

            // ‡§ö‡§æ‡§≤‡•Ç ‡§Æ‡§π‡§ø‡§®‡•ç‡§Ø‡§æ‡§ö‡§æ ‡§°‡•á‡§ü‡§æ ‡§Æ‡§ø‡§≥‡§µ‡§æ
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth(); // 0-11 (‡§ú‡§æ‡§®‡•á‡§µ‡§æ‡§∞‡•Ä=0)

            // ‡§ö‡§æ‡§≤‡•Ç ‡§Æ‡§π‡§ø‡§®‡•ç‡§Ø‡§æ‡§ö‡•á ‡§è‡§ï‡•Ç‡§£ ‡§¶‡§ø‡§µ‡§∏ ‡§ï‡§æ‡§¢‡§æ
            let daysInMonthForTarget = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            // ‡§∂‡•á‡§µ‡§ü‡§ö‡•ç‡§Ø‡§æ ‡§Æ‡§π‡§ø‡§®‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä (‡§´‡•á‡§¨‡•ç‡§∞‡•Å‡§µ‡§æ‡§∞‡•Ä ‡•®‡•¶‡•®‡•´) ‡§´‡§ï‡•ç‡§§ ‡•ß‡•® ‡§¶‡§ø‡§µ‡§∏ ‡§Æ‡•ã‡§ú‡§æ
            if (currentYear === fixedEndDate.getFullYear() && currentMonth === fixedEndDate.getMonth()) {
                daysInMonthForTarget = fixedEndDate.getDate();
            }

            // ‡§ö‡§æ‡§≤‡•Ç ‡§Æ‡§π‡§ø‡§®‡•ç‡§Ø‡§æ‡§ö‡•á ‡§ß‡•ç‡§Ø‡•á‡§Ø (Current Month Target) ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§æ
            const currentMonthTarget = dailyTarget * daysInMonthForTarget;
            
            const currentMonthKey = now.toISOString().slice(0, 7);
            const currentMonthStats = monthlyData[currentMonthKey] || { growth: 0 };
            const achievedGrowth = currentMonthStats.growth;
            const remainingTarget = Math.max(0, currentMonthTarget - achievedGrowth);
            const percentage = currentMonthTarget > 0 ? (achievedGrowth / currentMonthTarget) * 100 : 0;
            
            // ‡§Ü‡§ï‡§°‡•ç‡§Ø‡§æ‡§Ç‡§®‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§£‡•á
            document.getElementById('currentMonthAchieved').textContent = formatCurrencyPrecise(achievedGrowth);
            document.getElementById('currentMonthTarget').textContent = formatCurrencyPrecise(currentMonthTarget);
            document.getElementById('currentMonthProgressText').textContent = `${percentage.toFixed(1)}%`;
            document.getElementById('currentMonthProgressText').style.color = percentage >= 100 ? 'var(--accent-secondary)' : 'var(--text-primary)';

            const ctx = document.getElementById('currentMonthGoalChart').getContext('2d');
            if (currentMonthPieChartInstance) {
                currentMonthPieChartInstance.destroy();
            }
            currentMonthPieChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['‡§™‡•Ç‡§∞‡•ç‡§£ (Achieved)', '‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï (Remaining)'],
                    datasets: [{
                        data: [achievedGrowth, remainingTarget],
                        backgroundColor: ['#22c55e', '#e2e8f0'],
                        borderColor: ['#ffffff'],
                        borderWidth: 4,
                        hoverOffset: 4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    let value = context.raw;
                                    return `${label}: ${formatCurrencyPrecise(value)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        // ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤

        function renderStaffPerformanceChart(staffData) {
            const ctx = document.getElementById('staffPerformanceChart').getContext('2d');
            if (staffChartInstance) staffChartInstance.destroy();
            const sortedStaff = Object.values(staffData).sort((a,b) => b.growth - a.growth).slice(0, 10);
            staffChartInstance = new Chart(ctx, { 
                type: 'bar', 
                data: { labels: sortedStaff.map(s => s.name), datasets: [{ label: '‡§è‡§ï‡•Ç‡§£ ‡§µ‡§æ‡§¢ (Growth)', data: sortedStaff.map(s => s.growth), backgroundColor: 'rgba(14, 165, 233, 0.6)', borderColor: 'rgba(14, 165, 233, 1)', borderWidth: 1 }] }, 
                options: chartOptions 
            });
        }
        function renderMonthlyTrendChart(monthlyData) {
            const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
            if (monthlyChartInstance) monthlyChartInstance.destroy();
            const sortedMonths = Object.keys(monthlyData).sort();
            monthlyChartInstance = new Chart(ctx, { 
                type: 'line', 
                data: { labels: sortedMonths, datasets: [
                    { label: '‡§è‡§ï‡•Ç‡§£ ‡§µ‡§æ‡§ü‡§™', data: sortedMonths.map(m => monthlyData[m].disbursement), borderColor: 'var(--accent-primary)', backgroundColor: 'rgba(14, 165, 233, 0.2)', fill: true, tension: 0.3 }, 
                    { label: '‡§è‡§ï‡•Ç‡§£ ‡§µ‡§∏‡•Å‡§≤‡•Ä', data: sortedMonths.map(m => monthlyData[m].recovery), borderColor: 'var(--accent-danger)', backgroundColor: 'rgba(239, 68, 68, 0.2)', fill: true, tension: 0.3 }
                ]}, 
                options: { ...chartOptions, scales: { ...chartOptions.scales, x: { type: 'time', time: { unit: 'month', displayFormats: { month: 'MMM yy' }}, ticks: { color: 'var(--text-secondary)' }}}}
            });
        }
        function renderStaffTable(staffData) {
            const tableBody = document.getElementById('staffTableBody');
            tableBody.innerHTML = '';
            Object.values(staffData).sort((a,b) => b.growth - a.growth).forEach(data => {
                const growthClass = data.growth > 0 ? 'positive' : (data.growth < 0 ? 'negative' : '');
                tableBody.innerHTML += `<tr><td>${data.name}</td><td>${formatCurrency(data.disbursement)}</td><td>${formatCurrency(data.recovery)}</td><td class="${growthClass}">${formatCurrency(data.growth)}</td></tr>`;
            });
        }
        function renderPerformerCards(staffData) {
            const sortedStaff = Object.values(staffData).sort((a,b) => b.growth - a.growth);
            const topList = document.getElementById('topPerformersList');
            const lowList = document.getElementById('lowPerformersList');
            topList.innerHTML = sortedStaff.slice(0, 3).map(s => `<li><span>${s.name}</span><span class="positive">${formatCurrency(s.growth)}</span></li>`).join('');
            lowList.innerHTML = sortedStaff.slice(-3).reverse().map(s => `<li><span>${s.name}</span><span class="${s.growth >= 0 ? 'positive' : 'negative'}">${formatCurrency(s.growth)}</span></li>`).join('');
        }
        
        function openModal(title, data, valueType = 'growth') {
            document.getElementById('modalTitle').textContent = title;
            const modalBody = document.getElementById('modalBody');
            let tableHTML = `<table><thead><tr><th>‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä</th><th style="text-align:right;">‡§∞‡§ï‡•ç‡§ï‡§Æ</th></tr></thead><tbody>`;
            
            const sortedData = Object.entries(data).sort(([,a], [,b]) => b - a);

            for (const [name, value] of sortedData) {
                 const valueClass = valueType === 'growth' ? (value >= 0 ? 'positive' : 'negative') : '';
                 tableHTML += `<tr><td>${name}</td><td class="${valueClass}" style="text-align:right;">${formatCurrency(value)}</td></tr>`;
            }
            tableHTML += `</tbody></table>`;
            
            modalBody.innerHTML = tableHTML;
            document.getElementById('detailsModal').style.display = 'flex';
            document.body.classList.add('modal-open');
        }
        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        async function loadDashboard() {
            const [settingsData, dailyData, initialData] = await Promise.all([
                fetchSheetData(SETTINGS_SHEET),
                fetchSheetData(DAILY_DATA_SHEET),
                fetchSheetData(INITIAL_OUTSTANDING_SHEET)
            ]);
            
            if (!settingsData || !dailyData || !initialData) return;
            
            _allDailyData = dailyData.filter(row => row.dateObj);
            settingsData.forEach(item => { _settings[item['Setting Name']] = item['Value']; });
            initialData.forEach(item => { _initialStaffData[item['Staff Name']] = parseFloat(item['Outstanding Amount']) || 0; });
            
            document.getElementById('startDate').textContent = _settings['Start Date'];
            document.getElementById('endDate').textContent = _settings['End Date'];
            document.getElementById('initialOutstanding').textContent = formatCurrencyPrecise(_settings['Initial Outstanding']);
            document.getElementById('targetAmount').textContent = formatCurrencyPrecise(_settings['Target']);
            
            const [day, month, year] = _settings['End Date'].split('-');
            const endDateObj = new Date(`${year}-${month}-${day}`);
            document.getElementById('daysLeft').textContent = Math.max(0, Math.ceil((endDateObj - new Date()) / (1000 * 60 * 60 * 24)));
            
            const dates = _allDailyData.map(d => d.dateObj).filter(Boolean);
            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                document.getElementById('startDateFilter').valueAsDate = minDate;
                document.getElementById('endDateFilter').valueAsDate = maxDate;
                filterAndRenderDashboard(minDate, maxDate);
            } else {
                filterAndRenderDashboard(null, null);
            }
            
            document.getElementById('filterBtn').addEventListener('click', () => {
                const start = document.getElementById('startDateFilter').value;
                const end = document.getElementById('endDateFilter').value;
                const startDate = start ? new Date(start) : null;
                const endDate = end ? new Date(end) : null;
                if(endDate) endDate.setHours(23, 59, 59);
                filterAndRenderDashboard(startDate, endDate);
            });
            
            document.getElementById('kpiInitialCard').addEventListener('click', () => openModal('‡§∏‡•Å‡§∞‡•Å‡§µ‡§æ‡§§‡•Ä‡§ö‡•á ‡§Ü‡§â‡§ü‡§∏‡•ç‡§ü‡§Å‡§°‡§ø‡§Ç‡§ó - ‡§§‡§™‡§∂‡•Ä‡§≤', _initialStaffData, 'amount'));
            document.getElementById('kpiGrowthCard').addEventListener('click', () => {
                const growthData = Object.fromEntries(Object.values(_currentStaffPerformance).map(s => [s.name, s.growth]));
                openModal('‡§®‡§ø‡§µ‡•ç‡§µ‡§≥ ‡§µ‡§æ‡§¢ (Growth) - ‡§§‡§™‡§∂‡•Ä‡§≤', growthData, 'growth');
            });
            document.getElementById('kpiCurrentCard').addEventListener('click', () => openModal('‡§∏‡§ß‡•ç‡§Ø‡§æ‡§ö‡•á ‡§Ü‡§â‡§ü‡§∏‡•ç‡§ü‡§Å‡§°‡§ø‡§Ç‡§ó - ‡§§‡§™‡§∂‡•Ä‡§≤', _currentStaffOutstanding, 'amount'));

            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('detailsModal').addEventListener('click', (e) => { if(e.target.id === 'detailsModal') closeModal(); });
        }

        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>

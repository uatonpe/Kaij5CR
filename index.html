<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§∞‡•ã‡§ú‡§ö‡§æ ‡§°‡•á‡§ü‡§æ ‡§ü‡§æ‡§ï‡§æ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
        :root { --primary-color: #2c3e50; --secondary-color: #3498db; --background-color: #ecf0f1; --card-background: #ffffff; --text-color: #34495e; --border-color: #bdc3c7; --success-color: #2ecc71; --error-color: #e74c3c; --shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .container { width: 100%; max-width: 1200px; background: var(--card-background); padding: 30px; border-radius: 12px; box-shadow: var(--shadow); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        h2 { margin: 0; color: var(--primary-color); font-size: 24px; }
        .date-picker-container { display: flex; align-items: center; gap: 10px; }
        label { font-weight: 500; color: var(--text-color); }
        #entryDate { padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; color: var(--primary-color); }
        .table-header { display: grid; grid-template-columns: 2.5fr 1fr 1.5fr 1.5fr 0.5fr; gap: 15px; padding: 10px 15px; font-weight: 600; color: var(--primary-color); border-bottom: 2px solid var(--secondary-color); margin-bottom: 10px; }
        .data-row { display: grid; grid-template-columns: 2.5fr 1fr 1.5fr 1.5fr 0.5fr; gap: 15px; align-items: center; padding: 10px 15px; border-bottom: 1px solid #e0e0e0; }
        input, select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); font-size: 14px; box-sizing: border-box; }
        button { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; color: white; }
        .action-buttons { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; }
        #add-row-btn { background-color: var(--success-color); }
        #submit-all-btn { background-color: var(--secondary-color); }
        .delete-btn { background: none; border: none; color: var(--error-color); cursor: pointer; font-size: 22px; }
        #status-message { margin-top: 20px; text-align: center; font-weight: 500; min-height: 24px; padding: 10px; border-radius: 6px; visibility: hidden; opacity: 0; transition: visibility 0s, opacity 0.5s linear; }
        #status-message.success { background-color: #e8f8f2; color: #27ae60; visibility: visible; opacity: 1; }
        #status-message.error { background-color: #fdeded; color: #c0392b; visibility: visible; opacity: 1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h2>‡§∞‡•ã‡§ú‡§ö‡§æ ‡§°‡•á‡§ü‡§æ ‡§ü‡§æ‡§ï‡§æ</h2><div class="date-picker-container"><label for="entryDate">‡§§‡§æ‡§∞‡•Ä‡§ñ:</label><input type="date" id="entryDate"></div></div>
        <div class="table-header"><div>‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä</div><div>‡§®‡§µ‡•Ä‡§® ‡§ñ‡§æ‡§§‡•Ä</div><div>‡§µ‡§æ‡§ü‡§™ ‡§∞‡§ï‡•ç‡§ï‡§Æ</div><div>‡§µ‡§∏‡•Å‡§≤‡•Ä ‡§∞‡§ï‡•ç‡§ï‡§Æ</div><div>‡§ï‡•É‡§§‡•Ä</div></div>
        <div id="data-rows-container"></div>
        <div class="action-buttons"><button id="add-row-btn">‡§®‡§µ‡•Ä‡§® ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ú‡•ã‡§°‡§æ</button><button id="submit-all-btn">‡§∏‡§∞‡•ç‡§µ ‡§°‡•á‡§ü‡§æ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§æ</button></div>
        <div id="status-message"></div>
    </div>
    <template id="data-row-template">
        <div class="data-row">
            <div><select class="staffName"><option value="">‡§®‡§ø‡§µ‡§°‡§æ</option></select></div>
            <div><input type="number" class="newAccounts" placeholder="0"></div>
            <div><input type="number" class="disbursement" placeholder="0"></div>
            <div><input type="number" class="recovery" placeholder="0"></div>
            <div><button class="delete-btn">üóëÔ∏è</button></div>
        </div>
    </template>
    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxeJWTJiARN__wl0HGL_tCsX59NgrMAC_NUEbDkRaisHv6OMWegvbi-Z0Ni5ZdylJ6S/exec"; // ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§§‡•Ä‡§ö URL ‡§á‡§•‡•á ‡§ü‡§æ‡§ï‡§æ ‡§ú‡•Ä ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ü‡§æ‡§ï‡§≤‡•Ä ‡§Ü‡§π‡•á.
        
        const rowsContainer = document.getElementById('data-rows-container');
        const entryDateInput = document.getElementById('entryDate');
        const statusMessage = document.getElementById('status-message');
        const rowTemplate = document.getElementById('data-row-template');
        
        let staffNamesList = [];
        
        // Fetch staff names by calling the main doGet function without any parameters
        // This is a workaround, a dedicated getStaff action would be better.
        // For now, it will fetch all dashboard data just to get the staff list.
        document.addEventListener('DOMContentLoaded', () => {
            entryDateInput.valueAsDate = new Date();
             fetch(WEB_APP_URL)
                .then(res => res.json())
                .then(data => {
                    // Extract staff names from the daily performance object
                    if (data.status === 'success' && data.dailyData.staffPerformance) {
                        staffNamesList = data.dailyData.staffPerformance.map(staff => staff.name);
                        addNewRow(); // Add first row
                    } else {
                        showStatus('‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§±‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§Ø‡§æ‡§¶‡•Ä ‡§≤‡•ã‡§° ‡§π‡•ã‡§ä ‡§∂‡§ï‡§≤‡•Ä ‡§®‡§æ‡§π‡•Ä.', 'error');
                    }
                }).catch(() => showStatus('‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä!', 'error'));
        });

        const addNewRow = () => {
            const newRow = rowTemplate.content.cloneNode(true);
            const select = newRow.querySelector('.staffName');
            staffNamesList.forEach(name => select.add(new Option(name, name)));
            rowsContainer.appendChild(newRow);
        };

        document.getElementById('add-row-btn').addEventListener('click', addNewRow);
        document.getElementById('submit-all-btn').addEventListener('click', submitData);

        rowsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) e.target.closest('.data-row').remove();
        });

        function submitData() {
            const records = [];
            const rows = rowsContainer.querySelectorAll('.data-row');
            let isValid = true;

            rows.forEach(row => {
                const staffName = row.querySelector('.staffName').value;
                const newAccounts = row.querySelector('.newAccounts').value || 0;
                const disbursement = row.querySelector('.disbursement').value || 0;
                const recovery = row.querySelector('.recovery').value || 0;
                if (!staffName) { isValid = false; return; }
                records.push({ staffName, newAccounts, disbursement, recovery });
            });

            if (!isValid) { showStatus('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§∞‡•ç‡§µ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§±‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§®‡§ø‡§µ‡§° ‡§ï‡§∞‡§æ.', 'error'); return; }
            if (records.length === 0) { showStatus('‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§ø‡§Æ‡§æ‡§® ‡§è‡§ï ‡§®‡•ã‡§Ç‡§¶ ‡§ï‡§∞‡§æ.', 'error'); return; }

            const payload = { date: entryDateInput.value, records: records };
            
            showStatus('‡§ú‡§Æ‡§æ ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...', 'success');
            
            fetch(WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success'){
                    showStatus('‡§°‡•á‡§ü‡§æ ‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä‡§∞‡§ø‡§§‡•ç‡§Ø‡§æ ‡§ú‡§Æ‡§æ ‡§ù‡§æ‡§≤‡§æ!', 'success');
                    rowsContainer.innerHTML = '';
                    addNewRow();
                } else {
                    showStatus(`‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ${data.message}`, 'error');
                }
            }).catch(() => showStatus('‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä ‡§Ü‡§≤‡•Ä.', 'error'));
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = type;
            setTimeout(() => statusMessage.className = '', 4000);
        }
    </script>
</body>
</html>
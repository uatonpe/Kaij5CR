<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Data Entry (Team) | Mission 5 CR</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #f0f4f8; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px; 
            box-sizing: border-box; 
        }
        .container { 
            background-color: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 8px 24px rgba(0,37,86,0.1); 
            width: 100%; 
            max-width: 800px;
        }
        h2 { 
            text-align: center; 
            color: #1a3b5d; 
            margin-top: 0; 
            margin-bottom: 25px; 
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 500; 
            color: #334e68; 
        }
        input[type="date"], input[type="number"] { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #cdd3db; 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-size: 16px; 
            transition: border-color 0.3s, box-shadow 0.3s; 
        }
        input:focus { 
            outline: none; 
            border-color: #007bff; 
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1); 
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px 15px;
            border: 1px solid #e0e6ed;
            text-align: left;
        }
        th {
            background-color: #f0f4f8;
            font-weight: 600;
            color: #1a3b5d;
        }
        tbody tr:nth-child(even) {
            background-color: #f8fafc;
        }
        .loader {
            text-align: center;
            padding: 20px;
            color: #555;
        }
        button { 
            width: 100%; 
            padding: 14px; 
            margin-top: 20px;
            background: linear-gradient(90deg, #28a745, #218838); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 18px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: transform 0.2s, background 0.3s; 
        }
        button:hover { 
            transform: scale(1.02); 
            background: linear-gradient(90deg, #218838, #1e7e34);
        }
        button:disabled { 
            background: #a0aec0; 
            cursor: not-allowed; 
        }
        #message { 
            text-align: center; 
            margin-top: 20px; 
            font-weight: bold; 
            font-size: 16px; 
            white-space: pre-wrap;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h2>üöÄ ‡§ü‡•Ä‡§Æ ‡§¶‡•à‡§®‡§ø‡§ï ‡§°‡•á‡§ü‡§æ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä</h2>
        <form id="dataForm">
            <div class="form-group">
                <label for="reportDate">‡§§‡§æ‡§∞‡•Ä‡§ñ:</label>
                <input type="date" id="reportDate" name="reportDate" required>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§±‡•ç‡§Ø‡§æ‡§ö‡•á ‡§®‡§æ‡§µ</th>
                            <th>‡§®‡§µ‡•Ä‡§® ‡§µ‡§æ‡§ü‡§™ (‡§∞‡§ï‡•ç‡§ï‡§Æ)</th>
                            <th>‡§µ‡§∏‡•Å‡§≤‡•Ä (‡§∞‡§ï‡•ç‡§ï‡§Æ)</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <tr>
                            <td colspan="3" class="loader">‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§±‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§Ø‡§æ‡§¶‡•Ä ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <button type="submit" id="submitBtn">‡§∏‡§∞‡•ç‡§µ ‡§°‡•á‡§ü‡§æ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§æ</button>
        </form>
        <div id="message"></div>
    </div>

    <script>
        // ‚ñº‚ñº‚ñº‚ñº‚ñº ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§á‡§•‡•á ‡§≠‡§∞‡§æ ‚ñº‚ñº‚ñº‚ñº‚ñº
        const API_KEY = 'AIzaSyADpmUttHbznSowws1nk19BmJ7TjktsApU';
        const SHEET_ID = '1Mx7s64XhfbzwRNmUJ97Y9pep58UZ5L-yzENA34R23x8'; // ‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§∂‡•Ä‡§ü‡§ö‡§æ ‡§Ü‡§Ø‡§°‡•Ä
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzGBxXARbeSw8kddqoyTkWp_Am6_JIQ5FSmhkVIhtJi8FThg-iZdbtws4DP2prxAoOk/exec';
        const STAFF_MASTER_SHEET = 'StaffMaster';
        // ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤

        const tableBody = document.getElementById('dataTableBody');
        const reportDateInput = document.getElementById('reportDate');
        const form = document.getElementById('dataForm');
        const messageDiv = document.getElementById('message');
        const submitBtn = document.getElementById('submitBtn');
        
        // ‡§Ü‡§ú‡§ö‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§°‡§ø‡§´‡•â‡§≤‡•ç‡§ü ‡§Æ‡•ç‡§π‡§£‡•Ç‡§® ‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ
        reportDateInput.valueAsDate = new Date();

        // Google Sheet ‡§µ‡§∞‡•Ç‡§® ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§±‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§®‡§æ‡§µ‡•á ‡§≤‡•ã‡§° ‡§ï‡§∞‡•Ç‡§® ‡§ü‡•á‡§¨‡§≤ ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§æ
        async function loadStaffTable() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${STAFF_MASTER_SHEET}!A2:A?key=${API_KEY}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                const staffNames = data.values;

                if (staffNames && staffNames.length > 0) {
                    let tableRowsHTML = '';
                    staffNames.forEach(row => {
                        if (row[0]) {
                            const staffName = row[0].trim();
                            tableRowsHTML += `
                                <tr data-staff-name="${staffName}">
                                    <td>${staffName}</td>
                                    <td><input type="number" class="newDisbursement" value="0" min="0"></td>
                                    <td><input type="number" class="recoveryAmount" value="0" min="0"></td>
                                </tr>
                            `;
                        }
                    });
                    tableBody.innerHTML = tableRowsHTML;
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3" class="loader">‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§∏‡§æ‡§™‡§°‡§≤‡•á ‡§®‡§æ‡§π‡•Ä‡§§</td></tr>';
                }
            } catch (error) {
                console.error("Error loading staff names:", error);
                tableBody.innerHTML = '<tr><td colspan="3" class="loader">‡§è‡§∞‡§∞! ‡§®‡§æ‡§µ‡•á ‡§≤‡•ã‡§° ‡§π‡•ã‡§ä ‡§∂‡§ï‡§≤‡•Ä ‡§®‡§æ‡§π‡•Ä‡§§.</td></tr>';
            }
        }

        // ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∏‡§¨‡§Æ‡§ø‡§∂‡§® ‡§π‡§æ‡§§‡§æ‡§≥‡§æ
        form.addEventListener('submit', async (e) => {
            e.preventDefault(); // ‡§´‡•â‡§∞‡•ç‡§Æ‡§≤‡§æ ‡§°‡§ø‡§´‡•â‡§≤‡•ç‡§ü ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§π‡•ã‡§£‡•ç‡§Ø‡§æ‡§™‡§æ‡§∏‡•Ç‡§® ‡§•‡§æ‡§Ç‡§¨‡§µ‡§æ
            submitBtn.disabled = true;
            messageDiv.textContent = '';
            messageDiv.className = '';

            const reportDate = reportDateInput.value;
            const tableRows = tableBody.querySelectorAll('tr');
            
            const entriesToSubmit = [];
            // ‡§´‡§ï‡•ç‡§§ ‡§ú‡•ç‡§Ø‡§æ ‡§®‡•ã‡§Ç‡§¶‡•Ä‡§Ç‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§≠‡§∞‡§≤‡•Ä ‡§Ü‡§π‡•á, ‡§§‡•ç‡§Ø‡§æ‡§Ç‡§®‡§æ ‡§µ‡•á‡§ó‡§≥‡•á ‡§ï‡§æ‡§¢‡§æ
            tableRows.forEach(row => {
                const staffName = row.dataset.staffName;
                if (!staffName) return;

                const newDisbursement = parseFloat(row.querySelector('.newDisbursement').value) || 0;
                const recoveryAmount = parseFloat(row.querySelector('.recoveryAmount').value) || 0;

                if (newDisbursement > 0 || recoveryAmount > 0) {
                    entriesToSubmit.push({
                        staffName,
                        newDisbursement,
                        recoveryAmount
                    });
                }
            });

            if (entriesToSubmit.length === 0) {
                messageDiv.textContent = '‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§ø‡§Æ‡§æ‡§® ‡§è‡§ï‡§æ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§±‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§≠‡§∞‡§æ.';
                messageDiv.className = 'error';
                submitBtn.disabled = false;
                return;
            }

            let successCount = 0;
            let errorCount = 0;
            let errorMessages = [];

            // ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä‡§∏‡§æ‡§†‡•Ä ‡§è‡§ï-‡§è‡§ï ‡§ï‡§∞‡•Ç‡§® ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§æ
            for (let i = 0; i < entriesToSubmit.length; i++) {
                const entry = entriesToSubmit[i];
                submitBtn.textContent = `‡§™‡§æ‡§†‡§µ‡§§ ‡§Ü‡§π‡•á... (${i + 1}/${entriesToSubmit.length})`;

                const formData = new FormData();
                formData.append('reportDate', reportDate);
                formData.append('staffName', entry.staffName);
                formData.append('newDisbursement', entry.newDisbursement);
                formData.append('recoveryAmount', entry.recoveryAmount);
                
                try {
                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST',
                        body: formData,
                    });

                    if (response.ok) {
                        successCount++;
                    } else {
                        const errorText = await response.text();
                        throw new Error(errorText || 'Server error');
                    }
                } catch (error) {
                    errorCount++;
                    errorMessages.push(`‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä (${entry.staffName}): ${error.message}`);
                }
            }

            // ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§®‡§ø‡§ï‡§æ‡§≤ ‡§¶‡§æ‡§ñ‡§µ‡§æ
            if (errorCount === 0) {
                messageDiv.textContent = `${successCount} ‡§®‡•ã‡§Ç‡§¶‡•Ä ‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä‡§∞‡§ø‡§§‡•ç‡§Ø‡§æ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ù‡§æ‡§≤‡•ç‡§Ø‡§æ!`;
                messageDiv.className = 'success';
                // ‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä ‡§ù‡§æ‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞ ‡§´‡•â‡§∞‡•ç‡§Æ ‡§Ü‡§£‡§ø ‡§ü‡•á‡§¨‡§≤ ‡§∞‡§ø‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ
                form.reset();
                reportDateInput.valueAsDate = new Date();
                loadStaffTable(); 
            } else {
                messageDiv.textContent = `‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä: ${successCount} | ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä: ${errorCount}\n\n‡§ö‡•Å‡§ï‡§æ:\n${errorMessages.join('\n')}`;
                messageDiv.className = 'error';
            }

            submitBtn.disabled = false;
            submitBtn.textContent = '‡§∏‡§∞‡•ç‡§µ ‡§°‡•á‡§ü‡§æ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§æ';
        });

        document.addEventListener('DOMContentLoaded', loadStaffTable);
    </script>
</body>
</html>
